controller:
  name: "ryu-ctrl"
  image: "controller_ryu"
  command: "--observe-links --config-file /app/generic_controller/ryu.conf --ofp-listen-host 0.0.0.0 --ofp-tcp-listen-port 6653 generic_controller.app"
  volumes:
    - "../../containers/core/controller/generic_controller:/app/generic_controller"
    - "./:/app/exp"

qos:
  enabled: true
  type: "linux-htb"
  default_queue_id: 0

  # OPTIMIZACIÓN VM:
  apply_scope: "switch-switch" # default . Alternativa: "all-switch-ports"
  parallel_workers: 4 #
  post_start_sleep_s: 1.0 # 0.5–2.0
  use_no_wait: true # acelera ovs-vsctl
  ovs_timeout_s: 5
  strict: false # no aborta si falla en algún puerto

  # Definición de colas (ids = los que usas en OFPActionSetQueue(queue_id))
  # min_ratio/max_ratio son fracciones de la capacidad del enlace (cap_mbps del TCLink)
  # limit_pkts es el tamaño del buffer por cola (pfifo limit en paquetes)
  queues:
    - id: 3
      name: "HI-REL"
      min_ratio: 0.00
      max_ratio: 1.00
      limit_pkts: 1000

    - id: 2
      name: "LOW-LAT"
      min_ratio: 0.00
      max_ratio: 1.00
      limit_pkts: 1000

    - id: 1
      name: "HI-THRU"
      min_ratio: 0.00
      max_ratio: 1.00
      limit_pkts: 1000

    - id: 0
      name: "BEST-EFF"
      min_ratio: 0.00
      max_ratio: 1.00
      limit_pkts: 1000

hosts:
  brkMqtt0: # brokerIot0
    image: "mqtt_broker:latest"
    ip: "203.0.113.11/26"
    mac: "02:42:0a:00:00:01"
    comand_default:
      - "/usr/sbin/mosquitto -c /etc/mosquitto/mosquitto.conf -v; bash /app/tester_broker.sh"
    volumes:
      - "../../containers/services/mqtt_broker/mosquitto.conf:/etc/mosquitto/mosquitto.conf:ro"
      - "../../containers/services/mqtt_broker/tester_broker.sh:/app/tester_broker.sh:ro"

  brkAmqp0:
    image: "amqp_broker:latest"
    ip: "203.0.113.14/26"
    comand_default:
      - "bash /app/start_rabbit.sh"
    volumes:
      - "../../containers/services/amqp_broker/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro"
      - "../../containers/services/amqp_broker/start_rabbit.sh:/app/start_rabbit.sh:ro"

  brkMqtt1: # brokerIot1
    image: "mqtt_broker:latest"
    ip: "203.0.113.13/26"
    mac: "02:42:0a:00:00:02"
    comand_default:
      - "/usr/sbin/mosquitto -c /etc/mosquitto/mosquitto.conf -v; bash /app/tester_broker.sh"
    volumes:
      - "../../containers/services/mqtt_broker/mosquitto.conf:/etc/mosquitto/mosquitto.conf:ro"
      - "../../containers/services/mqtt_broker/tester_broker.sh:/app/tester_broker.sh:ro"

  srvHttp0: # serverIot1
    image: "iot_container:latest"
    ip: "203.0.113.10/26"
    volumes:
      - "../../containers/services/iot_container:/app"
    comand_default:
      - "python3 server.py"

  srvVoD0: # serverVod0
    image: "http_server_vod:latest"
    ip: "203.0.113.85/26"
    volumes:
      - "../../containers/services/http_server_vod/nginx.conf:/etc/nginx/nginx.conf:ro"
      - "../../data/videos/vod_http:/usr/share/nginx/html/videos:ro"
    comand_default:
      - 'nginx -g "daemon off;"'

  cliVoD0: # clientVod0
    image: "rtp_receiver_vod:latest"
    ip: "198.51.100.89/26"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "./get_nginx_video_time.sh --ip 203.0.113.85 --video hubble.mp4 --duration {tiempo}"
        estados: ["OFF1", "OFF2", "ON1", "ON2"]
        q_matrix:
          - [-0.1, 0.0, 0.1, 0.0]
          - [0.0, -0.005, 0.0, 0.005]
          - [0.004, 0.001, -0.005, 0.0]
          - [0.01, 0.09, 0.0, -0.1]
        limits:
          - [5, 30]
          - [150, 250]
          - [100, 300]
          - [0, 30]
  cliVoD1: # clientVod0
    image: "rtp_receiver_vod:latest"
    ip: "198.51.100.91/26"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "./get_nginx_video_time.sh --ip 203.0.113.85 --video hubble.mp4 --duration {tiempo}" #"./get_nginx_hls.sh --ip 203.0.113.85 --path videos/hls/4k_JF/index.m3u8 --duration {tiempo}"
        estados: ["OFF1", "OFF2", "ON1", "ON2"]
        q_matrix:
          - [-0.1, 0.0, 0.1, 0.0]
          - [0.0, -0.005, 0.0, 0.005]
          - [0.004, 0.001, -0.005, 0.0]
          - [0.01, 0.09, 0.0, -0.1]
        limits:
          - [5, 30]
          - [150, 250]
          - [100, 300]
          - [0, 30]

  srvFtp0:
    image: "ftp_server:latest"
    ip: "203.0.113.87/26"
    volumes:
      - "../../containers/services/ftp_server/vsftpd.conf:/etc/vsftpd/vsftpd.conf:ro"
      - "../../data/ftp:/data"
    comand_default:
      - "(id ftpuser || useradd -d /data -s /bin/bash ftpuser)"
      - "echo 'ftpuser:ftppass' | chpasswd"
      - "chown -R ftpuser:ftpuser /data"
      - "mkdir -p /var/run/vsftpd/empty && chown root:root /var/run/vsftpd/empty && chmod 755 /var/run/vsftpd/empty"
      - "mkdir -p /etc/vsftpd"
      - "cp /etc/vsftpd/vsftpd.conf /tmp/vsftpd.conf && chown root:root /tmp/vsftpd.conf && chmod 600 /tmp/vsftpd.conf"
      - "vsftpd /tmp/vsftpd.conf"

  srvIpTV0: # serverVod1
    image: "rtp_server_vod:latest"
    ip: "203.0.113.84/26"
    volumes:
      - "../../containers/services/rtp_server_vod/:/etc/mediamtx/:ro"
    comand_default:
      - "/usr/local/bin/mediamtx"

  srvCoap0: # serverIot2
    image: "iot_container:latest"
    ip: "203.0.113.12/26"
    volumes:
      - "../../containers/services/iot_container:/app"
    comand_default:
      - "python3 coap_server.py"

  srvWbS0: # serverIot3
    image: "iot_container:latest"
    ip: "203.0.113.15/26"
    volumes:
      - "../../containers/services/iot_container:/app"
    comand_default:
      - "python3 web_server.py"

  cliFtp0:
    image: "rtp_receiver_vod:latest"
    ip: "198.51.100.88/26"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "./ftp_client.sh -s 203.0.113.87 -f /bigfile.bin -U ftpuser -W ftppass -T {tiempo}"
        estados: ["OFF1", "ON1"]
        q_matrix:
          - [-0.1, 0.1]
          - [0.0167, -0.0167]
        limits:
          - [0, 30]
          - [40, 100]

  emIpTV0: # clientVod1
    image: "rtp_emitter_vod:latest"
    ip: "198.51.100.80/26"
    volumes:
      - "../../containers/services/rtp_emitter_vod:/app:ro"
      - "../../data/videos/vod_rtsp:/videos:ro"
    comand_default:
      - "./send_rtsp.sh --ip 203.0.113.84 --path mivideo --video /videos/godzilla.mp4 --bw 1000" # --bw 1000"
      #- "./send_rtsp.sh --ip 203.0.113.84 --path mivideo2 --video /videos/video_4k_15M.mp4 --bw 5000"
      #- "./send_rtsp.sh --ip 203.0.113.84 --path mivideo3 --video /videos/JF_4K_UHD.mp4 --bw 10000"

  cliHLS0: # clientVod2
    image: "rtp_receiver_vod:latest"
    ip: "198.51.100.81/26"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "./receive_rtsp_time.sh --ip 203.0.113.84 --path mivideo --duration {tiempo}"
        estados: ["OFF1", "OFF2", "ON1", "ON2"]
        q_matrix:
          - [-0.1, 0.0, 0.1, 0.0]
          - [0.0, -0.005, 0.0, 0.005]
          - [0.004, 0.001, -0.005, 0.0]
          - [0.01, 0.09, 0.0, -0.1]
        limits:
          - [5, 30]
          - [150, 250]
          - [100, 300]
          - [0, 30]

  cliSRT0: # clientVod2
    image: "rtp_receiver_vod:latest"
    ip: "198.51.100.82/26"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "./receive_rtsp_time.sh --ip 203.0.113.84 --path mivideo --duration {tiempo} --transport udp"
        estados: ["OFF1", "OFF2", "ON1", "ON2"]
        q_matrix:
          - [-0.1, 0.0, 0.1, 0.0]
          - [0.0, -0.005, 0.0, 0.005]
          - [0.004, 0.001, -0.005, 0.0]
          - [0.01, 0.09, 0.0, -0.1]
        limits:
          - [5, 30]
          - [150, 250]
          - [100, 300]
          - [0, 30]

  cliRtsp0: # clientVod2
    image: "rtp_receiver_vod:latest"
    ip: "198.51.100.83/26"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "./receive_rtsp_time.sh --ip 203.0.113.84 --path mivideo --duration {tiempo} --transport tcp"
        estados: ["OFF1", "OFF2", "ON1", "ON2"]
        q_matrix:
          - [-0.1, 0.0, 0.1, 0.0]
          - [0.0, -0.005, 0.0, 0.005]
          - [0.004, 0.001, -0.005, 0.0]
          - [0.01, 0.09, 0.0, -0.1]
        limits:
          - [5, 30]
          - [150, 250]
          - [100, 300]
          - [0, 30]

  srvVoIP0: # serVoIP0
    image: "rtp_container_voip:latest"
    ip: "203.0.113.80/26"
    volumes:
      - "../../containers/services/rtp_container_voip:/app:ro"
      - "../../data/voip:/data/voip:ro"
    comand_default:
      - "cd /app/ && ./server.sh 203.0.113.80"

  cliVoIP0: # cliVoIP0
    image: "rtp_container_voip:latest"
    ip: "198.51.100.87/26"
    volumes:
      - "../../containers/services/rtp_container_voip:/app:ro"
      - "../../data/voip:/data/voip:ro"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "cd /app/ && ./client_timeVC.sh 203.0.113.80 198.51.100.87 --duration {tiempo}"
        estados: ["OFF1", "OFF2", "ON1", "ON2"]
        q_matrix:
          - [-0.0167, 0.0, 0.0167, 0.0]
          - [0.0, -0.025, 0.0, 0.025]
          - [0.032, 0.008, -0.04, 0.0]
          - [0.04, 0.0267, 0.0, -0.0667]
        limits:
          - [40, 120]
          - [20, 100]
          - [5, 100]
          - [10, 60]

  emiCoap0: # emiCoap0
    image: "iot_container:latest"
    ip: "198.51.100.13/26"
    volumes:
      - "../../containers/services/iot_container:/app"
    comand_default:
      - "python3 coap_emisor.py 203.0.113.12 sensor/datos --bw 1"
      - "python3 coap_emisor.py 203.0.113.12 sensor/datos --bw 1"
      - "python3 mqtt_emisor.py --broker 203.0.113.13 --topic sensores/medidas --bw-kbps 2500"
      - "python3 mqtt_emisor.py --broker 203.0.113.13 --topic sensores/medidas --bw-kbps 2500"

  srvVC0: # serVC0
    image: "rtp_container_voip:latest"
    ip: "203.0.113.86/26"
    volumes:
      - "../../containers/services/rtp_container_voip:/app:ro"
      - "../../data/voip:/data/voip:ro"
    comand_default:
      - "cd /app/ && ./server.sh 203.0.113.86"

  cliVC0: # cliVC0
    image: "rtp_container_voip:latest"
    ip: "198.51.100.90/26"
    volumes:
      - "../../containers/services/rtp_container_voip:/app:ro"
      - "../../data/voip:/data/voip:ro"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "cd /app/ && ./client_timeVC.sh 203.0.113.86 198.51.100.90 --duration {tiempo}"
        estados: ["OFF1", "OFF2", "ON1", "ON2"]
        q_matrix:
          - [-0.0167, 0.0, 0.0167, 0.0]
          - [0.0, -0.025, 0.0, 0.025]
          - [0.032, 0.008, -0.04, 0.0]
          - [0.04, 0.0267, 0.0, -0.0667]
        limits:
          - [40, 120]
          - [20, 100]
          - [5, 100]
          - [10, 60]

  srvUdp0: # userIperf0
    image: "rtp_receiver_vod:latest"
    ip: "203.0.113.81/26"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    comand_default:
      - "iperf -s"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "./iperf_client.sh -c 198.51.100.84 -u -b 5M -t {tiempo}"
        estados: ["OFF1", "ON1"]
        q_matrix:
          - [-0.1, 0.1]
          - [0.01, -0.01]
        limits:
          - [5, 15]
          - [50, 150]

  srvUdp1: # userIperf1
    image: "rtp_receiver_vod:latest"
    ip: "203.0.113.82/26"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    comand_default:
      - "iperf -s"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "./iperf_client.sh -c 198.51.100.85 -u -b 5M -t {tiempo}"
        estados: ["OFF1", "ON1"]
        q_matrix:
          - [-0.1, 0.1]
          - [0.01, -0.01]
        limits:
          - [5, 15]
          - [50, 150]

  srvUdp2: # userIperf2
    image: "rtp_receiver_vod:latest"
    ip: "203.0.113.83/26"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    comand_default:
      - "iperf -s"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "./iperf_client.sh -c 198.51.100.86 -u -b 5M -t {tiempo}"
        estados: ["OFF1", "ON1"]
        q_matrix:
          - [-0.1, 0.1]
          - [0.01, -0.01]
        limits:
          - [5, 15]
          - [50, 150]

  cliUdp0: # userIperf3
    image: "rtp_receiver_vod:latest"
    ip: "198.51.100.84/26"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    comand_default:
      - "iperf -s"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "./iperf_client.sh -c 203.0.113.81 -u -b 5M -t {tiempo}"
        estados: ["OFF1", "ON1"]
        q_matrix:
          - [-0.1, 0.1]
          - [0.01, -0.01]
        limits:
          - [5, 15]
          - [50, 150]

  cliUdp1: # userIperf4
    image: "rtp_receiver_vod:latest"
    ip: "198.51.100.85/26"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    comand_default:
      - "iperf -s"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "./iperf_client.sh -c 203.0.113.82 -u -b 5M -t {tiempo}"
        estados: ["OFF1", "ON1"]
        q_matrix:
          - [-0.1, 0.1]
          - [0.01, -0.01]
        limits:
          - [5, 15]
          - [50, 150]

  cliUdp2: # userIperf5
    image: "rtp_receiver_vod:latest"
    ip: "198.51.100.86/26"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    comand_default:
      - "iperf -s"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "./iperf_client.sh -c 203.0.113.83 -u -b 5M -t {tiempo}"
        estados: ["OFF1", "ON1"]
        q_matrix:
          - [-0.1, 0.1]
          - [0.01, -0.01]
        limits:
          - [5, 15]
          - [50, 150]

  emiMqtt0: # emiIot1
    image: "iot_container:latest"
    ip: "198.51.100.10/26"
    volumes:
      - "../../containers/services/iot_container:/app"
    comand_default:
      - "python3 mqtt_emisor.py --broker 203.0.113.11 --topic events/ESP32_002/data --bw-kbps 2500"
      - "python3 mqtt_emisor.py --broker 203.0.113.11 --topic events/ESP32_002/data --bw-kbps 2500"
      - "python3 mqtt_emisor.py --broker 203.0.113.11 --topic events/ESP32_002/data --bw-kbps 2500"
      - "python3 mqtt_emisor.py --broker 203.0.113.11 --topic events/ESP32_002/data --bw-kbps 2500"

  cliIoT0: # clientIot1
    image: "iot_container:latest"
    ip: "198.51.100.15/26"
    volumes:
      - "../../containers/services/iot_container:/app"
    comand_default:
      - "python3 http_emisor.py --host 203.0.113.10 --path /datos --type PACIENTE --identifier 001 --bw-kbps 4000"
      - "python3 http_emisor.py --host 203.0.113.10 --path /datos --type PACIENTE --identifier 001 --bw-kbps 4000"
      - "python3 http_emisor.py --host 203.0.113.10 --path /datos --type PACIENTE --identifier 001 --bw-kbps 4000"
      - "python3 web_publisher.py --host 203.0.113.15 --port 8080 --topics sensor/temp"
      - "python3 web_publisher.py --host 203.0.113.15 --port 8080 --topics sensor/temp"
      - "python3 web_publisher.py --host 203.0.113.15 --port 8080 --topics sensor/temp"
      - "python3 amqp_publisher.py --host 203.0.113.14 --user iotuser --password iotpass --queue iot_queue --bw 1"
      - "python3 amqp_publisher.py --host 203.0.113.14 --user iotuser --password iotpass --queue iot_queue --bw 1"

  cliMqtt0: # clientIot0
    image: "iot_container:latest"
    ip: "198.51.100.12/26"
    volumes:
      - "../../containers/services/iot_container:/app"
    comand_default:
      - "python3 subscriber.py --host 203.0.113.11 --topic events/ESP32_002/data"
      - "python3 subscriber.py --host 203.0.113.11 --topic events/ESP32_002/data"
      - "python3 subscriber.py --host 203.0.113.11 --topic events/ESP32_002/data"
      - "python3 subscriber.py --host 203.0.113.11 --topic events/ESP32_002/data"

  cliMqtt1: # clientIot3
    image: "iot_container:latest"
    ip: "198.51.100.11/26"
    volumes:
      - "../../containers/services/iot_container:/app"
    comand_default:
      - "python3 subscriber.py --host 203.0.113.13 --topic sensores/medidas"
      - "python3 subscriber.py --host 203.0.113.13 --topic sensores/medidas"
      - "python3 subscriber.py --host 203.0.113.13 --topic sensores/medidas"

  cliCoap0: # clientIot2
    image: "iot_container:latest"
    ip: "198.51.100.14/26"
    volumes:
      - "../../containers/services/iot_container:/app"
    comand_default:
      - "python3 coap_client.py 203.0.113.12"
      - "python3 coap_client.py 203.0.113.12"
      - "python3 coap_client.py 203.0.113.12"
      - "python3 coap_client.py 203.0.113.12"

n_switches: 14
links:
  # --- Core / Núcleo (bypass alto, atajos por S6 más bajos) ---
  - link1: "switch1-eth1, switch2-eth1, 100"
  - link2: "switch1-eth2, switch10-eth1, 100"
  - link3: "switch1-eth3, switch3-eth1, 250" # acceso IoT/VoIP sin cuello en S1-S3
  - link4: "switch1-eth4, switch14-eth1, 250"

  - link5: "switch1-eth5, switch4-eth1, 250"
  - link6: "switch1-eth6, switch11-eth1, 250"

  - link7: "switch1-eth7, switch5-eth1, 100"
  - link8: "switch1-eth8, switch9-eth1, 100"

  - link9: "switch7-eth1, switch2-eth2, 100"
  - link10: "switch7-eth2, switch8-eth1, 250"

  - link11: "switch7-eth3, switch10-eth2, 100"
  - link12: "switch7-eth4, switch6-eth1, 250"

  - link13: "switch7-eth5, switch12-eth1, 250"
  - link14: "switch7-eth6, switch13-eth1, 250"
  - link15: "switch7-eth7, switch5-eth2, 250"
  - link16: "switch7-eth8, switch9-eth2, 250"

  # --- Hosts / Accesos (subir “elefantes” para que α escale) ---
  - link17: "emiCoap0-eth0, switch3-eth2, 50"
  - link18: "srvVoIP0-eth0, switch3-eth3, 100"
  - link19: "cliMqtt1-eth0, switch3-eth4, 50"
  - link20: "srvUdp2-eth0, switch3-eth5, 100"

  - link21: "cliVoD0-eth0, switch11-eth2, 100"

  - link22: "cliIoT0-eth0, switch12-eth2, 50"
  - link23: "emIpTV0-eth0, switch14-eth6, 100" # ELEFANTE (VOD)
  - link24: "srvUdp0-eth0, switch4-eth4, 50"

  - link25: "cliVC0-eth0, switch13-eth2, 100"
  - link26: "cliRtsp0-eth0, switch13-eth3, 100" # ELEFANTE (IPTV receptores)
  - link27: "cliHLS0-eth0, switch13-eth4, 100"

  - link28: "brkAmqp0-eth0, switch14-eth2, 50"
  - link29: "brkMqtt0-eth0, switch14-eth3, 50"
  - link30: "srvIpTV0-eth0, switch14-eth4, 100" # ELEFANTE (IPTV server)
  - link31: "srvVC0-eth0, switch14-eth5, 100"

  - link32: "srvHttp0-eth0, switch4-eth2, 50"
  - link33: "srvWbS0-eth0, switch4-eth3, 50"
  - link34: "cliUdp0-eth0, switch12-eth4, 100"

  - link35: "srvVoD0-eth0, switch6-eth2, 100" # ELEFANTE (VOD server)
  - link36: "brkMqtt1-eth0, switch8-eth5, 50"
  - link37: "srvCoap0-eth0, switch6-eth3, 50"
  - link38: "cliUdp1-eth0, switch6-eth4, 100"

  - link39: "cliMqtt0-eth0, switch12-eth3, 500"
  - link40: "cliSRT0-eth0, switch8-eth3, 100" # ELEFANTE (VOD SRT)
  - link41: "cliVoIP0-eth0, switch8-eth4, 100"
  - link42: "cliUdp2-eth0, switch8-eth2, 100"

  - link43: "srvFtp0-eth0, switch4-eth5, 100"
  - link44: "cliFtp0-eth0, switch12-eth5, 100"
  - link45: "emiMqtt0-eth0, switch13-eth5, 50"

  - link46: "srvUdp1-eth0, switch11-eth3, 100"
  - link47: "cliCoap0-eth0, switch11-eth4, 50"
  - link48: "cliVoD1-eth0, switch11-eth5, 100"
