controller:
  name: "ryu-ctrl"
  image: "controller_ryu"
  command: "--observe-links /app/app.py"
  volumes:
    - "../../containers/core/controller/baseline:/app"

hosts:
  brkMqtt0: # brokerIot0
    image: "mqtt_broker:latest"
    ip: "203.0.113.1/24"
    mac: "02:42:0a:00:00:01"
    comand_default:
      - "/usr/sbin/mosquitto -c /etc/mosquitto/mosquitto.conf -v; bash /app/tester_broker.sh"
    volumes:
      - "../../containers/services/mqtt_broker/mosquitto.conf:/etc/mosquitto/mosquitto.conf:ro"
      - "../../containers/services/mqtt_broker/tester_broker.sh:/app/tester_broker.sh:ro"

  brkAmqp0:
    image: "amqp_broker:latest"
    ip: "203.0.113.8/24"
    comand_default:
      - "bash /app/start_rabbit.sh"
    volumes:
      - "../../containers/services/amqp_broker/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro"
      - "../../containers/services/amqp_broker/start_rabbit.sh:/app/start_rabbit.sh:ro"

  cliMqtt0: # clientIot0
    image: "iot_container:latest"
    ip: "203.0.113.17/24"
    comand_default:
      - "python3 subscriber.py --host 203.0.113.1 --topic events/ESP32_002/data"
      - "python3 subscriber.py --host 203.0.113.1 --topic events/ESP32_002/data"
      - "python3 subscriber.py --host 203.0.113.1 --topic events/ESP32_002/data"
      - "python3 subscriber.py --host 203.0.113.1 --topic events/ESP32_002/data"
    volumes:
      - "../../containers/services/iot_container:/app"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "python3 subscriber.py --host 203.0.113.1 --topic events/ESP32_002/data --duration {tiempo}"
        estados: ["OFF1", "OFF2", "ON1", "ON2"]
        q_matrix:
          - [-0.5, 0.0, 0.5, 0.0]
          - [0.0, -0.005, 0.0, 0.005]
          - [0.002, 0.0015, -0.0035, 0.0]
          - [0.05, 0.05, 0.0, -0.1]
        limits:
          - [1, 5]
          - [170, 300]
          - [250, 300]
          - [5, 30]

  brkMqtt1: # brokerIot1
    image: "mqtt_broker:latest"
    ip: "203.0.113.6/24"
    mac: "02:42:0a:00:00:02"
    comand_default:
      - "/usr/sbin/mosquitto -c /etc/mosquitto/mosquitto.conf -v; bash /app/tester_broker.sh"
    volumes:
      - "../../containers/services/mqtt_broker/mosquitto.conf:/etc/mosquitto/mosquitto.conf:ro"
      - "../../containers/services/mqtt_broker/tester_broker.sh:/app/tester_broker.sh:ro"
  cliMqtt1: # clientIot3
    image: "iot_container:latest"
    ip: "192.51.100.28/24"
    volumes:
      - "../../containers/services/iot_container:/app"
    flows:
      - name: "0"
        n_proc: 4
        comand_process: "python3 subscriber.py --host 203.0.113.6 --topic sensores/medidas --duration {tiempo}"
        estados: ["OFF1", "OFF2", "ON1", "ON2"]
        q_matrix:
          - [-0.5, 0.0, 0.5, 0.0]
          - [0.0, -0.005, 0.0, 0.005]
          - [0.002, 0.0015, -0.0035, 0.0]
          - [0.05, 0.05, 0.0, -0.1]
        limits:
          - [1, 5]
          - [170, 300]
          - [250, 300]
          - [5, 30]

  srvHttp0: # serverIot1
    image: "iot_container:latest"
    ip: "203.0.113.2/24"
    volumes:
      - "../../containers/services/iot_container:/app"
    comand_default:
      - "./start_http.sh -w 8 -T 16 -P 5000"

  srvHttp1: # serverVod0
    image: "http_server_vod:latest"
    ip: "192.0.2.1/24"
    volumes:
      - "../../containers/services/http_server_vod/nginx.conf:/etc/nginx/nginx.conf:ro"
      - "../../data/videos/vod_http:/usr/share/nginx/html/videos:ro"
    comand_default:
      - 'nginx -g "daemon off;"'

  cliHttp1: # clientVod0
    image: "rtp_receiver_vod:latest"
    ip: "192.51.100.17/24"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "./get_nginx_video_time.sh --ip 192.0.2.1 --video hubble.mp4 --duration {tiempo}"
        estados: ["OFF1", "OFF2", "ON1", "ON2"]
        q_matrix:
          - [-0.1, 0.0, 0.1, 0.0]
          - [0.0, -0.005, 0.0, 0.005]
          - [0.004, 0.001, -0.005, 0.0]
          - [0.01, 0.09, 0.0, -0.1]
        limits:
          - [5, 30]
          - [150, 250]
          - [100, 300]
          - [0, 30]
      - name: "1"
        n_proc: 0
        comand_process: "./get_nginx_hls.sh --ip 192.0.2.1 --path videos/hls/4k_JF/index.m3u8 --duration {tiempo}"
        estados: ["OFF1", "OFF2", "ON1", "ON2"]
        q_matrix:
          - [-0.1, 0.0, 0.1, 0.0]
          - [0.0, -0.005, 0.0, 0.005]
          - [0.004, 0.001, -0.005, 0.0]
          - [0.01, 0.09, 0.0, -0.1]
        limits:
          - [5, 30]
          - [150, 250]
          - [100, 300]
          - [0, 30]

  srvFtp0:
    image: "ftp_server:latest"
    ip: "203.0.113.7/24"
    volumes:
      - "../../containers/services/ftp_server/vsftpd.conf:/etc/vsftpd/vsftpd.conf:ro"
      - "../../data/ftp:/data"
    comand_default:
      - "(id ftpuser || useradd -d /data -s /bin/bash ftpuser)"
      - "echo 'ftpuser:ftppass' | chpasswd"
      - "chown -R ftpuser:ftpuser /data"
      - "mkdir -p /var/run/vsftpd/empty && chown root:root /var/run/vsftpd/empty && chmod 755 /var/run/vsftpd/empty"
      - "mkdir -p /etc/vsftpd"
      - "cp /etc/vsftpd/vsftpd.conf /tmp/vsftpd.conf && chown root:root /tmp/vsftpd.conf && chmod 600 /tmp/vsftpd.conf"
      - "vsftpd /tmp/vsftpd.conf"

  cliFtp0:
    image: "rtp_receiver_vod:latest"
    ip: "192.51.100.100/24"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "./ftp_client.sh -s 203.0.113.7 -f /bigfile.bin -U ftpuser -W ftppass -T {tiempo}"
        estados: ["OFF1", "ON1"]
        q_matrix:
          - [-0.1, 0.1]
          - [0.0167, -0.0167]
        limits:
          - [0, 30]
          - [40, 100]

  srvRtp0: # serverVod1
    image: "rtp_server_vod:latest"
    ip: "192.0.2.2/24"
    volumes:
      - "../../containers/services/rtp_server_vod/:/etc/mediamtx/:ro"
    comand_default:
      - "/usr/local/bin/mediamtx"

  cliRtp0: # clientVod1
    image: "rtp_emitter_vod:latest"
    ip: "192.51.100.18/24"
    volumes:
      - "../../containers/services/rtp_emitter_vod:/app:ro"
      - "../../data/videos/vod_rtsp:/videos:ro"
    comand_default:
      - "./send_rtsp.sh --ip 192.0.2.2 --path mivideo --video /videos/godzilla.mp4 --bw 1000"
      - "./send_rtsp.sh --ip 192.0.2.2 --path mivideo2 --video /videos/video_4k_15M.mp4"
      - "./send_rtsp.sh --ip 192.0.2.2 --path mivideo3 --video /videos/JF_4K_UHD.mp4"

  cliRtp1: # clientVod2
    image: "rtp_receiver_vod:latest"
    ip: "192.51.100.21/24"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "./receive_hls_time.sh --ip 192.0.2.2 --path mivideo --duration {tiempo}"
        estados: ["OFF1", "OFF2", "ON1", "ON2"]
        q_matrix:
          - [-0.1, 0.0, 0.1, 0.0]
          - [0.0, -0.005, 0.0, 0.005]
          - [0.004, 0.001, -0.005, 0.0]
          - [0.01, 0.09, 0.0, -0.1]
        limits:
          - [5, 30]
          - [150, 250]
          - [100, 300]
          - [0, 30]
      - name: "1"
        n_proc: 0
        comand_process: "./receive_srt_time.sh --ip 192.0.2.2 --path mivideo2 --duration {tiempo}"
        estados: ["OFF1", "OFF2", "ON1", "ON2"]
        q_matrix:
          - [-0.1, 0.0, 0.1, 0.0]
          - [0.0, -0.005, 0.0, 0.005]
          - [0.004, 0.001, -0.005, 0.0]
          - [0.01, 0.09, 0.0, -0.1]
        limits:
          - [5, 30]
          - [150, 250]
          - [100, 300]
          - [0, 30]
      - name: "2"
        n_proc: 0
        comand_process: "./receive_rtsp_time.sh --ip 192.0.2.2 --path mivideo3 --duration {tiempo}"
        estados: ["OFF1", "OFF2", "ON1", "ON2"]
        q_matrix:
          - [-0.1, 0.0, 0.1, 0.0]
          - [0.0, -0.005, 0.0, 0.005]
          - [0.004, 0.001, -0.005, 0.0]
          - [0.01, 0.09, 0.0, -0.1]
        limits:
          - [5, 30]
          - [150, 250]
          - [100, 300]
          - [0, 30]

  srvRtp1: # serVoIP0
    image: "rtp_container_voip:latest"
    ip: "192.51.100.19/24"
    volumes:
      - "../../containers/services/rtp_container_voip:/app:ro"
      - "../../data/voip:/data/voip:ro"
    comand_default:
      - "cd /app/ && ./server.sh 192.51.100.19"

  cliRtp2: # cliVoIP0
    image: "rtp_container_voip:latest"
    ip: "192.51.100.20/24"
    volumes:
      - "../../containers/services/rtp_container_voip:/app:ro"
      - "../../data/voip:/data/voip:ro"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "cd /app/ && ./client_time.sh 192.51.100.19 192.51.100.20 --duration {tiempo}"
        estados: ["OFF1", "OFF2", "ON1", "ON2"]
        q_matrix:
          - [-0.0167, 0.0, 0.0167, 0.0]
          - [0.0, -0.025, 0.0, 0.025]
          - [0.032, 0.008, -0.04, 0.0]
          - [0.04, 0.0267, 0.0, -0.0667]
        limits:
          - [40, 120]
          - [20, 100]
          - [5, 100]
          - [10, 60]

  srvCoap0: # serverIot2
    image: "iot_container:latest"
    ip: "203.0.113.3/24"
    volumes:
      - "../../containers/services/iot_container:/app"
    comand_default:
      - "python3 coap_server.py"

  cliCoap0: # emiCoap0
    image: "iot_container:latest"
    ip: "192.51.100.30/24"
    volumes:
      - "../../containers/services/iot_container:/app"
    comand_default:
      - "python3 coap_emisor.py 203.0.113.3 sensor/datos --bw 1" # 500kbps
      - "python3 coap_emisor.py 203.0.113.3 sensor/datos2 --bw 1" # 500kbps

  cliCoap1: # clientIot2
    image: "iot_container:latest"
    ip: "203.0.113.19/24"
    volumes:
      - "../../containers/services/iot_container:/app"
    comand_default:
      - "python3 coap_client.py 203.0.113.3"

  srvWbS1: # serverIot3
    image: "iot_container:latest"
    ip: "203.0.113.4/24"
    volumes:
      - "../../containers/services/iot_container:/app"
    comand_default:
      - "python3 web_server.py"

  srvRtp2: # serVC0
    image: "rtp_container_voip:latest"
    ip: "192.51.100.101/24"
    volumes:
      - "../../containers/services/rtp_container_voip:/app:ro"
      - "../../data/voip:/data/voip:ro"
    comand_default:
      - "cd /app/ && ./server.sh 192.51.100.101"

  cliRtp3: # cliVC0
    image: "rtp_container_voip:latest"
    ip: "192.51.100.100/24"
    volumes:
      - "../../containers/services/rtp_container_voip:/app:ro"
      - "../../data/voip:/data/voip:ro"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "cd /app/ && ./client_timeVC.sh 192.51.100.101 192.51.100.100 --duration {tiempo}"
        estados: ["OFF1", "OFF2", "ON1", "ON2"]
        q_matrix:
          - [-0.0167, 0.0, 0.0167, 0.0]
          - [0.0, -0.025, 0.0, 0.025]
          - [0.032, 0.008, -0.04, 0.0]
          - [0.04, 0.0267, 0.0, -0.0667]
        limits:
          - [40, 120]
          - [20, 100]
          - [5, 100]
          - [10, 60]

  srvUdp0: # userIperf0
    image: "rtp_receiver_vod:latest"
    ip: "192.51.100.22/24"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    comand_default:
      - "iperf3 -s"

  srvUdp1: # userIperf1
    image: "rtp_receiver_vod:latest"
    ip: "192.51.100.23/24"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    comand_default:
      - "iperf3 -s"

  srvUdp2: # userIperf2
    image: "rtp_receiver_vod:latest"
    ip: "192.51.100.24/24"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    comand_default:
      - "iperf3 -s"

  cliUdp0: # userIperf3
    image: "rtp_receiver_vod:latest"
    ip: "192.51.100.25/24"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "./iperf_client.sh -c 192.51.100.22 -u -b 1M -t {tiempo}"
        estados: ["OFF1", "ON1"]
        q_matrix:
          - [-0.1, 0.1]
          - [0.1, -0.1]
        limits:
          - [5, 15]
          - [5, 15]

  cliUdp1: # userIperf4
    image: "rtp_receiver_vod:latest"
    ip: "192.51.100.26/24"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "./iperf_client.sh -c 192.51.100.23 -u -b 1M -t {tiempo}"
        estados: ["OFF1", "ON1"]
        q_matrix:
          - [-0.1, 0.1]
          - [0.1, -0.1]
        limits:
          - [5, 15]
          - [5, 15]

  cliUdp2: # userIperf5
    image: "rtp_receiver_vod:latest"
    ip: "192.51.100.27/24"
    volumes:
      - "../../containers/services/rtp_receiver_vod:/app:ro"
    flows:
      - name: "0"
        n_proc: 0
        comand_process: "./iperf_client.sh -c 192.51.100.24 -u -b 1M -t {tiempo}"
        estados: ["OFF1", "ON1"]
        q_matrix:
          - [-0.1, 0.1]
          - [0.1, -0.1]
        limits:
          - [5, 15]
          - [5, 15]

  cliMqtt2: # emiIot1
    image: "iot_container:latest"
    ip: "192.51.100.29/24"
    volumes:
      - "../../containers/services/iot_container:/app"
    comand_default:
      - "python3 mqtt_emisor.py --broker 203.0.113.1 --topic events/ESP32_002/data --bw-kbps 2500" # Sismico
      - "python3 mqtt_emisor.py --broker 203.0.113.6 --topic sensores/seguridad --bw-kbps 2500" # Seguridad
      - "python3 mqtt_emisor.py --broker 203.0.113.6 --topic sensores/medidas --bw-kbps 2500" # Medidas

  cliHttp0: # clientIot1
    image: "iot_container:latest"
    ip: "203.0.113.18/24"
    volumes:
      - "../../containers/services/iot_container:/app"
    comand_default:
      - "python3 http_emisor.py --host 203.0.113.2 --path /datos --type PACIENTE --identifier 001 --bw-kbps 4000"
      - "python3 http_emisor.py --host 203.0.113.2 --path /datos --type MEDICO --identifier 001 --bw-kbps 4000"
      - "python3 web_publisher.py --host 203.0.113.4 --port 8080 --topics sensor/temp --bw 1"
      - "python3 web_publisher.py --host 203.0.113.4 --port 8080 --topics sensor2/temp --bw 1"
      - "python3 amqp_publisher.py --host 203.0.113.8 --user iotuser --password iotpass --queue iot_queue --bw 1"
      - "python3 amqp_publisher.py --host 203.0.113.8 --user iotuser --password iotpass --queue iot_queue2 --bw 1"

n_switches: 17

links:
  - link1: "switch1-eth1, switch2-eth1, 30"
  - link2: "switch1-eth2, switch10-eth2, 30"
  - link3: "switch1-eth3, switch3-eth1, 20"

  - link4: "switch2-eth2, switch6-eth2, 30"
  - link5: "switch2-eth4, switch14-eth1, 10"
  - link6: "switch2-eth3, switch4-eth1, 30"

  - link7: "switch6-eth1, switch10-eth1, 30"
  - link8: "switch4-eth2, switch5-eth1, 30"
  - link9: "switch5-eth2, switch6-eth3, 30"
  - link10: "switch5-eth3, switch7-eth1, 30"
  - link11: "switch5-eth4, switch16-eth1, 20"
  - link12: "switch7-eth2, switch17-eth1, 20"
  - link13: "switch6-eth4, switch9-eth1, 30"
  - link14: "switch7-eth3, switch9-eth2, 30"
  - link15: "switch8-eth1, switch9-eth3, 30"
  - link16: "switch8-eth2, switch10-eth3, 30"
  - link17: "switch10-eth4, switch11-eth1, 20"
  - link18: "switch9-eth4, switch12-eth1, 20"
  - link19: "switch8-eth3, switch13-eth1, 20"
  - link20: "switch4-eth3, switch15-eth1, 20"

  - link21: "cliCoap0-eth0, switch3-eth2, 5"
  - link22: "cliRtp2-eth0, switch3-eth3, 10"
  - link23: "cliMqtt2-eth0, switch3-eth4, 5"
  - link24: "srvUdp2-eth0, switch3-eth5, 10"

  - link25: "cliRtp0-eth0, switch11-eth2, 20"

  - link26: "cliHttp0-eth0, switch12-eth2, 5"
  - link27: "cliHttp1-eth0, switch12-eth3, 20"
  - link28: "srvUdp0-eth0, switch12-eth4, 10"

  - link29: "cliRtp3-eth0, switch13-eth2, 10"
  - link30: "cliRtp1-eth0, switch13-eth3, 20"
  - link31: "srvUdp1-eth0, switch13-eth4, 10"

  - link32: "cliMqtt1-eth0, switch14-eth2, 5"
  - link33: "srvHttp1-eth0, switch14-eth3, 20"
  - link34: "srvRtp0-eth0, switch14-eth4, 20"
  - link35: "srvRtp2-eth0, switch14-eth5, 10"

  - link36: "srvHttp0-eth0, switch15-eth2, 10"
  - link37: "srvWbS1-eth0, switch15-eth3, 10"
  - link38: "cliUdp0-eth0, switch15-eth4, 10"

  - link39: "brkMqtt0-eth0, switch16-eth2, 10"
  - link40: "brkMqtt1-eth0, switch16-eth3, 10"
  - link41: "srvCoap0-eth0, switch16-eth4, 10"
  - link42: "cliUdp1-eth0, switch16-eth5, 10"

  - link43: "cliMqtt0-eth0, switch17-eth2, 5"
  - link44: "cliCoap1-eth0, switch17-eth3, 5"
  - link45: "srvRtp1-eth0, switch17-eth4, 5"
  - link46: "cliUdp2-eth0, switch17-eth5, 10"

  - link47: "srvFtp0-eth0, switch15-eth5, 20"
  - link48: "cliFtp0-eth0, switch12-eth5, 20"
  - link49: "brkAmqp0-eth0, switch13-eth5, 10"
